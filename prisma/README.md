# CTDP链管理模块 - 数据库配置指南

## 概述

本文档介绍了HolySeat项目中CTDP（链式时延协议）链管理模块的数据库配置。数据库设计基于[文字版理论.md](../Docs/文字版理论.md)中的CTDP理论和[设计文档 v2.0](../Docs/Modules/HolySeat%20-%20CTDP链管理模块设计文档%20v2.0.md)。

## 核心理论映射

### 1. 神圣座位原理 → SacredContext 表
- **理论基础**: "神圣座位"是一个虚构的标志，一旦触发就必须以最好状态专注完成任务
- **数据库实现**: `SacredContext` 表存储各种专注情境的配置和规则
- **核心字段**: `rules`, `environment` JSON字段存储具体的约束规则

### 2. 工作量证明 → CTDPChain 表
- **理论基础**: 每次成功完成任务都会增加链的编号(#1, #2, #3...)，形成沉没成本
- **数据库实现**: `counter` 字段记录当前链长度，`status` 管理链状态
- **约束力来源**: 链越长，打破的代价越大（所有累积的工作量证明瞬间归零）

### 3. 下必为例原理 → CTDPLog 表
- **理论基础**: 面临违规时只能选择：1)链断裂清零 2)允许但以后必须都允许
- **数据库实现**: `LogType.RULE_UPDATED` 记录规则变更，`metadata` 存储规则变更详情
- **判例法机制**: 通过日志记录确保规则的一致性执行

### 4. 线性时延原理 → AuxiliaryChain 表
- **理论基础**: "预约15分钟后开始"比"立即开始"阻力更小
- **数据库实现**: 预约机制降低启动阻力，`delayMinutes` 可配置延迟时间
- **时间平移**: 将任务启动从高权重的当下移到低权重的未来

## 数据库表结构

### 核心实体

1. **SacredContext (神圣情境)**
   - 存储专注场景的配置和规则
   - 是CTDP链的拥有者和管理者

2. **CTDPChain (主链)**
   - 记录连续成功的专注任务链
   - 体现"工作量证明"和沉没成本累积

3. **CTDPLog (任务日志)**
   - 详细记录每次任务的执行情况
   - 支持"下必为例"的规则变更追踪

4. **AuxiliaryChain (辅助链)**
   - 实现预约机制，降低任务启动阻力
   - 体现"线性时延原理"

5. **Tag (标签)**
   - 任务分类和数据分析
   - 与CTDPLog多对多关联

## 安装和初始化

### 1. 安装依赖
```bash
npm install @prisma/client
npm install prisma tsx --save-dev
```

### 2. 生成数据库
```bash
# 生成Prisma客户端
npm run db:generate

# 推送数据库结构（开发阶段）
npm run db:push

# 或创建正式迁移
npm run db:migrate
```

### 3. 种子数据
```bash
# 初始化基础数据
npm run db:seed
```

### 4. 查看数据库
```bash
# 打开Prisma Studio
npm run db:studio
```

## 核心业务流程

### 启动任务流程
1. 用户选择一个SacredContext
2. 系统查找该context下的ACTIVE链，没有则创建新链
3. 开始专注任务，记录开始日志
4. 任务完成后调用`incrementChain`，链长度+1
5. 任务失败则调用`breakChain`，链状态变为BROKEN

### 预约机制流程
1. 用户触发预约信号（如打响指）
2. 创建AuxiliaryChain记录，设置15分钟延迟
3. 到期后必须启动对应的SacredContext任务
4. 启动成功则履行预约，失败则记录违约

## 扩展性考虑

数据库设计充分考虑了未来扩展：

- **JSON字段**: `rules`, `environment`, `metadata` 支持灵活的配置扩展
- **枚举类型**: 便于添加新的状态和类型
- **关联关系**: 支持复杂的数据查询和分析
- **时间戳**: 完整的审计追踪

## 注意事项

1. **一个情境只能有一条ACTIVE链**: 通过业务逻辑而非数据库约束保证
2. **JSON字段存储**: 配置和规则使用JSON存储，便于灵活配置
3. **软删除**: 重要数据使用状态标记而非物理删除
4. **级联删除**: 设置了适当的外键级联规则

---

*本数据库设计完全遵循CTDP理论的核心原理，确保每个表和字段都有明确的理论依据和实际用途。*
